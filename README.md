### 1. 项目功能总览

**核心定位**：基于 RAG（检索增强生成）技术的智能运维问答助手，支持多模态（文本+图片）交互和严格的权限管理。

#### 1.1 用户角色与权限
*   **Admin (管理员)**：
    *   **全功能访问**：拥有所有模块的访问权限。
    *   **知识库管理**：上传文档（直接入库）、审批普通用户上传的文档、拒绝不合规文档。
    *   **未知问题学习**：查看系统无法回答的问题（状态为 `unknown`），手动录入标准答案，系统自动将其向量化并存入知识库。
    *   **训练模式**：自问自答模式，用于快速补充 FAQ 知识对。
    *   **日志审计**：查看所有用户的问答历史、来源文档及状态。
    *   **数据大屏**：查看系统运行状态、热门问题统计等。
*   **User (普通用户)**：
    *   **智能问答**：基于已批准的知识库进行问答。
    *   **文档上传**：可以上传文档，但需经管理员审批通过后才能生效。
    *   **历史记录**：仅查看自己的问答历史。
    *   **文档下载**：在回答中若引用了文档，可直接下载源文件。
*   **Guest (访客)**：
    *   **受限问答**：仅能进行问答，有提问次数限制。
    *   **禁止上传**：无法上传任何文件。

#### 1.2 核心业务功能
*   **多模态 RAG 问答**：
    *   **文本**：支持 PDF, DOCX, TXT, MD 等格式文档的检索与回答。
    *   **图片**：支持上传运维截图/架构图，系统调用视觉模型（GLM-4V）理解图片内容，结合知识库回答。
*   **文档溯源与下载**：
    *   每次回答都会列出“参考文档”，并提供**下载按钮**，支持下载原始上传文件或向量库中的源文件。
*   **移动端适配**：
    *   完全响应式设计，手机端自动切换为抽屉式侧边栏（Hamburger Menu），保证移动办公体验。

### 2. 服务启动与停止

项目分为后端、前端和（可选的）内网穿透服务。

#### 2.1 启动服务

**1. 后端服务 (FastAPI)**
*   **位置**: `/home/leiqy/ops-agent/backend`
*   **命令**:
    ```bash
    cd /home/leiqy/ops-agent/backend
    uvicorn main:app --host 0.0.0.0 --port 8000 --reload
    ```
*   **说明**: 启动在 `8000` 端口，`--reload` 表示代码变更后自动重启。

**2. 前端服务 (React/Vite)**
*   **位置**: `/home/leiqy/ops-agent/frontend`
*   **命令**:
    ```bash
    cd /home/leiqy/ops-agent/frontend
    npm run dev -- --host
    ```
*   **说明**: 启动在 `5173` 端口，`--host` 允许局域网访问。

**3. 内网穿透 (Cloudflare Tunnel - 可选)**
*   **位置**: `/home/leiqy/ops-agent`
*   **命令**:
    ```bash
    ./tools/cloudflared tunnel --config tunnel_config.yml run
    ```
*   **说明**: 用于将本地服务暴露到公网，方便远程访问。

#### 2.2 停止服务
在运行服务的终端窗口中，按下 `Ctrl + C` 即可停止服务。

### 3. 技术原理与架构

#### 3.1 RAG (检索增强生成) 流程
1.  **文档入库**: 用户上传文档 -> 文本提取 (Loader) -> 分块 (Splitter) -> 向量化 (Embedding Model) -> 存入 PostgreSQL (`pgvector`)。
2.  **检索 (Retrieval)**: 用户提问 -> 问题向量化 -> 在数据库中搜索 Top-K 最相似的文档片段。
3.  **生成 (Generation)**: 将“系统提示词 + 检索到的文档内容 + 用户问题”组装成 Prompt -> 发送给大模型 (GLM-4) -> 生成最终答案。

#### 3.2 未知问题学习机制
1.  **捕获**: 当 LLM 回答包含“无法回答”、“未找到信息”等关键词时，后端将该条记录状态标记为 `unknown`。
2.  **学习**: 管理员在界面上看到这些问题，输入标准答案。
3.  **入库**: 系统将“问题+标准答案”组合成一个新的文档片段，存入知识库（Metadata 标记为 `learned`）。
4.  **生效**: 下次用户再问相同问题时，检索系统会优先匹配到这个“学习”过的答案。

### 4. 关键文件与存放位置

| 类别 | 路径 | 说明 |
| :--- | :--- | :--- |
| **项目根目录** | `/home/leiqy/ops-agent/` | |
| **后端代码** | `/home/leiqy/ops-agent/backend/` | `main.py` (入口), `rag/` (核心逻辑) |
| **前端代码** | `/home/leiqy/ops-agent/frontend/src/` | `App.jsx` (主界面), `components/` |
| **上传文档** | `/home/leiqy/ops-agent/backend/uploads/` | 用户上传的原始知识库文件 |
| **用户图片** | `/home/leiqy/ops-agent/backend/user_images/` | 聊天中发送的图片 |
| **数据库** | PostgreSQL (Docker/Local) | 数据存储在 PG 的数据卷中，非直接文件 |
| **日志** | 数据库 `chat_logs` 表 | 记录所有问答历史 |

---

### 建议文档 (README.md)

为了方便您后续维护，我为您准备了一份详细的 `README.md` 内容，您可以将其保存到项目根目录下：

```markdown /home/leiqy/ops-agent/README.md
# Ops Agent - 智能运维助手

Ops Agent 是一个基于 RAG (Retrieval-Augmented Generation) 架构的智能运维问答系统，旨在通过 AI 技术辅助运维人员快速检索文档、解决故障，并支持未知问题的主动学习。

## 🚀 功能特性

### 1. 角色体系
- **管理员 (Admin)**: 全局掌控，包括文档审批、未知问题学习、训练模式、日志审计。
- **普通用户 (User)**: 知识库问答、文档上传（需审批）、历史记录查看、源文档下载。
- **访客 (Guest)**: 仅限基础问答，有配额限制。

### 2. 核心能力
- **多模态问答**: 支持文本和图片（架构图/报错截图）提问。
- **精准溯源**: 回答均基于知识库，提供参考文档来源及下载。
- **自我进化**: 
  - **未知问题捕获**: 自动识别回答失败的问题。
  - **人机协同学习**: 管理员录入标准答案后，系统自动“学会”并存入知识库。
- **移动端适配**: 完美支持手机浏览器访问，提供原生 App 般的体验。

## 📂 目录结构

```bash
/home/leiqy/ops-agent/
├── backend/                # Python FastAPI 后端
│   ├── main.py             # API 入口
│   ├── rag/                # RAG 核心算法 (QA, Loader, Retriever)
│   ├── uploads/            # [存储] 知识库原始文件
│   └── user_images/        # [存储] 用户上传的图片
├── frontend/               # React + Vite 前端
│   ├── src/App.jsx         # 主应用逻辑
│   └── vite.config.js      # 前端代理配置
└── tools/                  # 运维工具 (如 Cloudflared)
```

## 🛠️ 快速启动

### 1. 启动后端
```bash
cd backend
# 确保已配置 .env 中的 ZHIPUAI_API_KEY 和 数据库连接
uvicorn main:app --host 0.0.0.0 --port 8000 --reload
```

### 2. 启动前端
```bash
cd frontend
npm run dev -- --host
```

### 3. 访问地址
- **Web 界面**: http://localhost:5173 (或服务器 IP:5173)
- **API 文档**: http://localhost:8000/docs

## 🧠 技术原理

1.  **文档处理**: 上传 -> 文本提取 -> 切片 -> 向量化 (Embedding) -> PGVector 存储。
2.  **问答流程**: 提问 -> 向量检索 (Top-K) -> 上下文组装 -> LLM 生成 -> 结果返回。
3.  **学习机制**: 记录低置信度回答 -> 管理员人工修正 -> 修正结果向量化入库 -> 闭环优化。

## 📝 维护指南

- **数据库备份**: 定期备份 PostgreSQL 数据库。
- **文档清理**: `backend/uploads` 目录存储原始文件，可定期归档。
- **日志分析**: 通过管理员界面的“用户日志”功能分析高频问题。
```
